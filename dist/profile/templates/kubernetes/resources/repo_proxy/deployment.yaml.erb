---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
    name: repo-proxy
    labels:
        app: repo-proxy
        type: repo-proxy
        logtype: archive
spec:
    replicas: 3
    template:
        metadata:
            labels:
                app: repo-proxy
                type: repo-proxy
                logtype: archive
        spec:
            # Nginx user need write permission on /var/cache/nginx
            initContainers:
                - name: volume-mount-hack
                  # Use the same image than repo-proxy in order to have the user nginx
                  image: jenkinsciinfra/repo-proxy:<%= @parameters['image_tag'] %>
                  command: ["sh", "-c", "chown -R $(id -u nginx):$(id -g nginx) /var/cache/nginx"]
                  volumeMounts:
                      - name: repo-proxy
                        mountPath: /var/cache/nginx
            containers:
                - name: repo-proxy
                  image: jenkinsciinfra/repo-proxy:<%= @parameters['image_tag'] %>
                  imagePullPolicy: Always
                  livenessProbe:
                      httpGet:
                          path: /repo1/org/springframework/spring-tx/maven-metadata.xml
                          port: 80
                          scheme: HTTP
                      initialDelaySeconds: 20
                      timeoutSeconds: 5
                  readinessProbe:
                      httpGet:
                          path: /repo1/org/springframework/spring-tx/maven-metadata.xml
                          port: 80
                          scheme: HTTP
                      initialDelaySeconds: 30
                      timeoutSeconds: 5
                  volumeMounts:
                    - name: repo-proxy
                      mountPath: /var/cache/nginx
            volumes:
              - name: repo-proxy
                <% if @parameters['deploy_context'] == 'local' %>
                emptyDir: {}
                <% else %>
                persistentVolumeClaim:
                    claimName: repo-proxy
                <% end -%>
