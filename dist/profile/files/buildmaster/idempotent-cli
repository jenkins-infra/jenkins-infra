#!/bin/bash

set -eux -o pipefail

## Array of argument to bake the commands to execute within the container
# Note that we use the default container's user as it's not always the "jenkins"'s container user
docker_cmd=("/usr/bin/docker" "exec" "jenkins")

## Path to the jenkins home inside the container
jenkins_container_home=/var/jenkins_home

if test "${1}" == "install-plugin"
then
  ## Install plugin with jenkins-plugin-cli does not from the Jenkins's availability state
  exec "${docker_cmd[@]}" jenkins-plugin-cli --plugins "${2}" --plugin-download-directory "${jenkins_container_home}/plugins"
else
  ## URL to reach Jenkins from INSIDE the container
  jenkins_url="http://127.0.0.1:8080"

  ## Determine the CLI jar file to used by searching it (instead of downloading on each call)
  cli_host_path="$("${docker_cmd[@]}" find "${jenkins_container_home}"/war/WEB-INF/lib -type f -name 'cli-*.jar' | head -n1 `# Only use the first item returned from find`)"

  exec "${docker_cmd[@]}" java -jar "${cli_host_path}" -s "${jenkins_url}" "$@"
fi
